<script lang="ts">
  import type { PluginId, PluginTaskState } from "$lib/api/types/plugin";
  import type { PluginRegistryEntry } from "$lib/api/types/plugins_registry";

  import { toast } from "svelte-sonner";
  import { i18nContext } from "$lib/i18n/i18n.svelte";
  import { toastErrorMessage } from "$lib/api/utils/error";
  import SolarRefreshLinear from "~icons/solar/refresh-linear";
  import { createUpdatePlugin } from "$lib/api/plugins_registry";
  import { reloadPlugin } from "$lib/api/plugins/plugins.requests";
  import { createUninstallPlugin } from "$lib/api/plugins/plugins.mutations";

  import Button from "../input/Button.svelte";
  import { onMount } from "svelte";

  type Props = {
    id: PluginId;
    icon: string | null;
    name: string;
    description: string | null;
    version: string;
    internal: boolean;
    authors: string[];
    state: PluginTaskState;
    latestVersion?: {
      version: string;
      remotePlugin: PluginRegistryEntry;
    };
    developerMode?: boolean;
  };

  const {
    id,
    icon,
    name,
    description,
    version,
    internal,
    authors,
    state: taskState,
    latestVersion,
    developerMode,
  }: Props = $props();

  const i18n = i18nContext.get();

  const uninstall = createUninstallPlugin();
  const update = createUpdatePlugin();

  function handleReload() {
    const reloadPromise = reloadPlugin(id);

    toast.promise(reloadPromise, {
      loading: i18n.f("plugin_reloading"),
      success: i18n.f("plugin_reloaded"),
      error: toastErrorMessage(i18n.f("plugin_reload_error")),
    });
  }

  function handleUninstall() {
    const uninstallPromise = uninstall.mutateAsync({
      pluginId: id,
    });

    toast.promise(uninstallPromise, {
      loading: i18n.f("plugin_uninstalling"),
      success: i18n.f("plugin_uninstalled"),
      error: toastErrorMessage(i18n.f("plugin_uninstall_error")),
    });
  }

  async function handleUpdate() {
    if (!latestVersion) return;

    const updatePromise = update.mutateAsync({
      repo: latestVersion.remotePlugin.repo,
      version: latestVersion.version,
      pluginId: id,
    });
    toast.promise(updatePromise, {
      loading: i18n.f("plugin_updating"),
      success: i18n.f("plugin_updated"),
      error: toastErrorMessage(i18n.f("plugin_update_error")),
    });
  }

  let bgColor: string = $state(
    "radial-gradient(circle at 50% 50%, rgba(200,200,255,0.2), rgba(200,200,255,0.1))",
  );
  let imgEl: HTMLImageElement | undefined = $state();

  $effect(() => {
    const currentImg = imgEl;

    if (!currentImg) {
      return;
    }

    if (currentImg.complete) {
      extractColor(currentImg);
    } else {
      currentImg.onload = () => extractColor(currentImg);
    }
  });

  /**
   * Handles extracting a color to use for the background color
   * from the provided icon image. This calculates and sets the
   * background to an average of the colors in the image
   *
   * @param imgEl Icon image element
   */
  function extractColor(imgEl: HTMLImageElement) {
    const canvas = document.createElement("canvas");
    canvas.width = imgEl.naturalWidth;
    canvas.height = imgEl.naturalHeight;

    const ctx = canvas.getContext("2d");
    if (ctx === null) return;

    ctx.drawImage(imgEl, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    let r = 0;
    let g = 0;
    let b = 0;
    let count = 0;

    for (let i = 0; i < data.length; i += 4) {
      const alpha = data[i + 3];
      if (alpha > 0) {
        // ignore fully transparent pixels
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }
    }

    r = Math.round(r / count);
    g = Math.round(g / count);
    b = Math.round(b / count);

    bgColor = `radial-gradient(circle at 50% 50%, rgba(${r}, ${g}, ${b}, 0.2), rgba(${r}, ${g}, ${b}, 0.1))`;
  }
</script>

<div class="card">
  <div class="left">
    <div class="head">
      <div class="head__text">
        <span class="version">
          {version}

          {#if latestVersion}
            <span class="version__new">
              New: {latestVersion.version}
            </span>
          {/if}
        </span>

        {#if developerMode && !internal}
          <span class="state">{taskState}</span>
        {/if}
      </div>
    </div>

    <h2 class="name">
      {name}
    </h2>

    {#if description}
      <p class="description">
        {description}
      </p>
    {/if}

    {#if authors.length > 0}
      <span class="authors">
        By {authors.join(", ")}
      </span>
    {/if}

    <div class="actions">
      {#if developerMode}
        <Button
          variant="secondary"
          title={i18n.f("Reload")}
          size="small"
          onclick={handleReload}
        >
          <SolarRefreshLinear />
        </Button>
      {/if}

      {#if latestVersion}
        <Button
          variant="secondary"
          size="small"
          onclick={handleUpdate}
          loading={update.isPending}
          disabled={uninstall.isPending}
        >
          {i18n.f("update")}
        </Button>
      {/if}

      {#if !internal}
        <Button
          variant="secondary"
          size="small"
          onclick={handleUninstall}
          loading={uninstall.isPending}
          disabled={update.isPending}
        >
          {i18n.f("uninstall")}
        </Button>
      {/if}
    </div>
  </div>

  <div class="right" style:background={bgColor}>
    {#if icon}
      <img
        class="icon"
        bind:this={imgEl}
        src={icon}
        alt="{name} Plugin Icon"
        crossorigin="anonymous"
      />
    {:else}
      <img
        class="icon"
        bind:this={imgEl}
        src="/missing-icon.png"
        alt="{name} Plugin Icon"
        crossorigin="anonymous"
      />
    {/if}
  </div>
</div>

<style>
  .card {
    display: flex;
    flex-flow: row;
    gap: var(--tp-space-2);
    align-items: flex-start;

    border-radius: var(--tp-radius-md);
    background-color: var(--tp-bg-secondary);
    border: 1px solid var(--tp-border-secondary);
  }

  .icon {
    width: 64px;
    height: 64px;
    border-radius: 8px;
  }

  .left {
    display: flex;
    flex-flow: column;
    gap: var(--tp-space-2);
    align-items: flex-start;
    flex: auto;
    padding: var(--tp-space-3);
  }

  .right {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    aspect-ratio: 1/1;
    border-top-right-radius: var(--tp-radius-md);
    border-bottom-right-radius: var(--tp-radius-md);
  }

  .head {
    display: flex;
    flex-flow: row;
    align-items: center;
    justify-content: space-between;
    gap: var(--tp-space-2);

    width: 100%;
  }

  .head__text {
    display: flex;
    flex-flow: row;
    align-items: center;
    gap: var(--tp-space-2);
  }

  .version {
    color: var(--tp-text-tertiary);
    font-size: var(--tp-text-xs);
  }

  .version__new {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background-color: #6d5c92;

    margin-left: var(--tp-space-2);
    color: var(--tp-text-primary);
    border-radius: var(--tp-radius-lg);
  }

  .description {
    color: var(--tp-text-secondary);
    font-size: var(--tp-text-xs);
    max-width: 100%;
  }

  .name {
    font-size: var(--tp-text-lg);
    line-height: var(--tp-leading-tight);
  }

  .actions {
    display: flex;
    gap: var(--tp-space-2);
    flex-shrink: 0;
  }

  .state {
    vertical-align: middle;
    font-size: var(--tp-text-xs);
    color: var(--tp-text-tertiary);
  }

  .authors {
    font-size: var(--tp-text-xs);
    color: var(--tp-text-tertiary);
  }
</style>
